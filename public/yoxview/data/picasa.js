/*!
 * YoxView Picasa plugin
 * http://yoxigen.com/yoxview/
 *
 * Copyright (c) 2010 Yossi Kolesnicov
 *
 * Licensed under the MIT license.
 * http://www.opensource.org/licenses/mit-license.php
 *
 * Date: 1st March, 2010
 * Version : 1.4b
 */ 
function yoxview_picasa(){function o(a){var f=a.url+a.user;if(a.album)f+="/album/"+a.album;f+="?imgmax="+a.imagesMaxSize+"&alt=json";if(a.thumbnailsMaxSize)f+="&thumbsize="+a.thumbnailsMaxSize;if(a.authkey)f+="&authkey="+a.authkey;return f}function m(a,f){for(var d=f.length;d>=0;d--){a=parseInt(a);var c=f[d];if(a>=c)return c}return a}function p(a,f,d){jQuery.each(a.feed.entry,function(c,i){var k=i.summary.$t;k={thumbnailSrc:i.media$group.media$thumbnail[0].url,link:i.link[1].href,thumbnailImg:f?f.children("img:first"): null,media:{src:i.content.src,title:k,alt:k}};d.push(k)})}var g=jQuery;this.getImagesData=function(a,f,d){var c=jQuery.extend({},{url:"http://picasaweb.google.com/data/feed/api/user/",setThumbnail:true,setSingleAlbumThumbnails:true,setTitle:true},d.dataSourceOptions);if(c.album=="")c.album=null;if(c.imagesMaxSize)c.imagesMaxSize=m(c.imagesMaxSize,q);var i=screen.width>screen.height?screen.width:screen.height;if(!c.imagesMaxSize||i<c.imagesMaxSize)c.imagesMaxSize=m(i,q);if(c.thumbnailsMaxSize)c.thumbnailsMaxSize= m(c.thumbnailsMaxSize,t);i=o(c);var k=[],w=a.data("yoxview").viewIndex;if(c.album){d.onLoadBegin&&d.onLoadBegin();g.jsonp({url:i,async:false,dataType:"jsonp",callbackParameter:"callback",success:function(b){var e=b.feed,l=e.title.$t;p(b,void 0,k);if(k.length!=0&&c.setThumbnail)if(c.setSingleAlbumThumbnails){a.addClass("yoxview-thumbnails");if(c.setTitle){e=g("<div>",{className:"yoxview-thumbnails-details"});b=b.feed.author[0];e.append("<h2>"+l+"</h2>","By ","<a href='"+b.uri.$t+"' title=\"Go to "+ b.name.$t+"'s Picasa page\" target='_blank'>"+b.name.$t+"</a>","<div style='clear:both;'></div>").prependTo(a)}a.yoxthumbs({images:k,onClick:function(h){yoxviewApi.openGallery(g(h.liveFired).data("yoxview").viewIndex,g(h.currentTarget).data("yoxthumbs").imageIndex);return false}})}else{b=[];b.push({link:e.link[1].href,thumbnailImg:e.icon.$t,media:{title:l+" ("+e.gphoto$numphotos.$t+" images)",alt:albumtitle}});a.yoxthumbs({images:b,onClick:function(h){yoxviewApi.thumbnail=g(h.currentTarget);yoxviewApi.openGallery(g(h.liveFired).data("yoxview").viewIndex, g(h.currentTarget).data("yoxthumbs").imageIndex);return false}})}d.onLoadComplete&&d.onLoadComplete()},error:function(b,e){d.onLoadError&&d.onLoadError("Album '"+c.album+"' for user '"+c.user+"' not found.")}})}else{var r=0,u=/http:\/\/picasaweb.google.*\/([^\/]+)\/([^\?]+).*/,n=a[0].tagName=="A";(n?a:a.find("a:has(img)")).each(function(){var b=g(this),e=this.href.match(u);if(e){e={user:e[1],album:e[2]};var l=b.data("yoxview");l?jQuery.extend(l,e):b.data("yoxview",e);var h=n?b.data("yoxview"):b.parent().data("yoxview"); b.bind("click.yoxview",function(){var j=g(this).data("yoxview");if(h.imagesAreSet)yoxviewApi.openGallery(n?b.data("yoxview").viewIndex:b.parent().data("yoxview").viewIndex);else{b.css("cursor","wait");g.ajax({url:o(jQuery.extend({},c,j)),dataType:"jsonp",success:function(v){var s=[];p(v,b,s);h.images=s;h.imagesAreSet=true;b.css("cursor","");yoxviewApi.openGallery(h.viewIndex)}})}return false});r++}});if(r==0){d.onLoadBegin&&d.onLoadBegin();g.jsonp({url:i,dataType:"jsonp",callbackParameter:"callback", success:function(b){if(b.feed.entry){if(c.setTitle){var e=b.feed.author[0];g("<div>",{className:"yoxview-thumbnails-details"}).append("<h2><a href='"+e.uri.$t+"' target='_blank' title=\"Go to "+e.name.$t+"'s gallery in Picasa\">"+e.name.$t+"</a>'s gallery</h2>","<div style='clear:both;'></div>").prependTo(a)}var l=[];jQuery.each(b.feed.entry,function(h,j){j.gphoto$numphotos.$t!="0"&&l.push({thumbnailSrc:j.media$group.media$thumbnail[0].url,thumbnailDimensions:{width:j.media$group.media$thumbnail[0].width, height:j.media$group.media$thumbnail[0].height},link:j.link[1].href,media:{title:j.title.$t+" ("+j.gphoto$numphotos.$t+" images)",alt:j.title.$t}})});a.yoxthumbs({images:l});a.yoxthumbs("thumbnails").yoxview(f,d);d.onLoadComplete&&d.onLoadComplete()}else d.onNoData&&d.onNoData()},error:function(b,e){d.onLoadError&&d.onLoadError("User '"+c.user+"' not found.")}})}}return k};var t=[32,48,64,72,104,144,150,160],q=[94,110,128,200,220,288,320,400,512,576,640,720,800,912,1024,1152,1280,1440,1600]};